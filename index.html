<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LunaMatrix ‚Äî –ù—É–º–µ—Ä–æ–ª–æ–≥-—ç–∫—Å–ø–µ—Ä—Ç</title>
  <meta name="description" content="–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–µ–º–æ-–æ—Ç–≤–µ—Ç—ã –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏. PDF ‚Äî –ø–æ—Å–ª–µ e-mail." />
  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1020;
      --card:#0E1630cc;
      --stroke:#223055;
      --text:#EAF0FF;
      --muted:#AAB6DA;
      --accent:#6B8CFF;
      --accent2:#B06BFF;
      --good:#31D0AA;
      --warn:#FFB020;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 24px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 70% -10%, rgba(107,140,255,.25), transparent 60%),
        radial-gradient(900px 700px at 10% 10%, rgba(176,107,255,.20), transparent 55%),
        radial-gradient(700px 600px at 70% 110%, rgba(49,208,170,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 14px;
    }
    .app{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:18px;
    }
    @media (max-width: 920px){
      .app{grid-template-columns:1fr}
    }
    .hero{
      border:1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      border-radius: var(--radius2);
      padding:22px 22px 18px;
      position:relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(400px 260px at 20% 20%, rgba(107,140,255,.25), transparent 60%),
        radial-gradient(420px 300px at 90% 0%, rgba(176,107,255,.22), transparent 60%);
      filter: blur(10px);
      opacity:.9;
      pointer-events:none;
    }
    .hero > *{position:relative}
    .brand{
      display:flex; align-items:center; gap:12px;
      margin-bottom:10px;
    }
    .logo{
      width:46px; height:46px;
      border-radius:14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(107,140,255,.95), rgba(176,107,255,.9));
      box-shadow: 0 12px 30px rgba(107,140,255,.25);
      border:1px solid rgba(255,255,255,.14);
    }
    .logo span{font-size:22px; transform: translateY(-1px)}
    .title{
      line-height:1.1;
    }
    .title h1{margin:0; font-size:20px; letter-spacing:.2px}
    .title p{margin:4px 0 0; color:var(--muted); font-size:13px}
    .chips{
      display:flex; flex-wrap:wrap; gap:8px;
      margin:14px 0 0;
    }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(14,22,48,.55);
      color:var(--muted);
      font-size:12px;
    }

    .chat{
      border:1px solid rgba(255,255,255,.07);
      background: rgba(14,22,48,.45);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 560px;
    }
    .chat-head{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .status{
      display:flex; align-items:center; gap:8px;
      color:var(--muted);
      font-size:12px;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--good);
      box-shadow: 0 0 0 6px rgba(49,208,170,.12);
    }
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.15);
      color:var(--muted);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .pill:hover{border-color:rgba(107,140,255,.35); color:var(--text)}
    .messages{
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
      flex:1;
    }
    .row{
      display:flex;
      align-items:flex-end;
      gap:8px;
      max-width: 92%;
    }
    .row.user{margin-left:auto; flex-direction:row-reverse}
    .bubble{
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.15);
      white-space:pre-wrap;
      line-height:1.35;
      font-size:14px;
    }
    .row.bot .bubble{
      background: rgba(14,22,48,.70);
      border-color: rgba(255,255,255,.10);
    }
    .row.user .bubble{
      background: linear-gradient(135deg, rgba(107,140,255,.30), rgba(176,107,255,.22));
      border-color: rgba(107,140,255,.35);
    }
    .meta{
      font-size:11px; color:rgba(170,182,218,.75);
      margin:0 4px;
    }
    .typing{
      display:inline-flex; align-items:center; gap:6px;
    }
    .typing i{
      width:6px;height:6px;border-radius:50%;
      background: rgba(234,240,255,.65);
      display:inline-block;
      animation: bounce 1.1s infinite ease-in-out;
    }
    .typing i:nth-child(2){animation-delay:.15s}
    .typing i:nth-child(3){animation-delay:.30s}
    @keyframes bounce{
      0%,80%,100%{transform:translateY(0); opacity:.55}
      40%{transform:translateY(-4px); opacity:1}
    }

    .composer{
      padding:12px 12px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      align-items:center;
      background: rgba(0,0,0,.10);
    }
    .input{
      flex:1;
      display:flex;
      gap:10px;
      align-items:center;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(14,22,48,.55);
      border-radius: 14px;
      padding:10px 12px;
    }
    input{
      width:100%;
      background:transparent;
      border:0;
      outline:none;
      color:var(--text);
      font-size:14px;
    }
    input::placeholder{color:rgba(170,182,218,.65)}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(107,140,255,.18);
      color:var(--text);
      padding:10px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }
    .btn:hover{border-color:rgba(107,140,255,.55); background: rgba(107,140,255,.26)}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }
    .kbtn{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(14,22,48,.55);
      cursor:pointer;
      color:var(--text);
      font-size:13px;
      user-select:none;
    }
    .kbtn:hover{border-color:rgba(107,140,255,.45)}
    .kbtn.primary{
      background: rgba(107,140,255,.20);
      border-color: rgba(107,140,255,.35);
    }
    .small{
      font-size:12px;
      color:rgba(170,182,218,.78);
      margin-top:10px;
      line-height:1.35;
    }
    .right{
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .card{
      border:1px solid rgba(255,255,255,.07);
      background: rgba(14,22,48,.35);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .card h3{margin:0 0 8px; font-size:16px}
    .card p{margin:0; color:var(--muted); font-size:13px; line-height:1.45}
    .warn{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,176,32,.25);
      background: rgba(255,176,32,.08);
      color:rgba(255,224,170,.95);
      font-size:12px;
      line-height:1.35;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="app">
    <div class="hero">
      <div class="brand">
        <div class="logo"><span>üåô</span></div>
        <div class="title">
          <h1>–ù—É–º–µ—Ä–æ–ª–æ–≥-—ç–∫—Å–ø–µ—Ä—Ç LunaMatrix</h1>
          <p>–î–µ–º–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ. PDF/–¢–µ–∫—Å—Ç ‚Äî —Å—Ä–∞–∑—É –Ω–∞ —Å–∞–π—Ç–µ.</p>
        </div>
      </div>

      <div class="chips">
        <div class="chip">‚ú® –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –¥–µ–º–æ-–æ—Ç–≤–µ—Ç</div>
        <div class="chip">üíû –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</div>
        <div class="chip">ü§ë –î–µ–Ω—å–≥–∏ / –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –ü—Ä–æ—Ñ–µ—Å—Å–∏–∏</div>
        <div class="chip">üîÆ –ü—Ä–æ–≥–Ω–æ—Å—Ç–∏–∫–∞</div>
        <div class="chip">üî• –ü–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç</div>
      </div>

      <div class="small">
        –°—Ü–µ–Ω–∞—Ä–∏–π: –∏–º—è ‚Üí –¥–∞—Ç–∞ ‚Üí –¥–µ–º–æ ‚Üí –≤—ã–±–æ—Ä —É—Å–ª—É–≥–∏ ‚Üí –¥–æ–ø. –¥–∞–Ω–Ω—ã–µ ‚Üí –¢–µ–∫—Å—Ç/ PDF.
      </div>
    </div>

    <div class="right">
      <div class="chat" id="chat">
        <div class="chat-head">
          <div class="status">
            <span class="dot"></span>
            <span id="statusText">–ì–æ—Å—Ç—å</span>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <div class="pill" id="resetBtn">–°–±—Ä–æ—Å</div>
          </div>
        </div>

        <div class="messages" id="messages"></div>

        <div class="composer">
          <div class="input">
            <input id="textInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" autocomplete="off"/>
          </div>
          <button class="btn" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div class="card">
        <h3>–í–∞–∂–Ω–æ</h3>
        <p>–¢–µ–∫—Å—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ <code>/service</code>. PDF —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ <code>/pdf</code> (–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ PDF).</p>
        <div class="warn">
          –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—å <code>/demo</code>, <code>/service</code> –∏–ª–∏ <code>/pdf</code> –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Äî —ç—Ç–æ GET –∏ –±—É–¥–µ—Ç ‚ÄúNot found‚Äù. –†–∞–±–æ—Ç–∞–µ—Ç POST-–∑–∞–ø—Ä–æ—Å–æ–º.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // === –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ===
  const API_BASE = "https://numerology-api.kseniabarzali.workers.dev"; // –ø—Ä–æ–≤–µ—Ä—å –¥–æ–º–µ–Ω

  // === –°–æ—Å—Ç–æ—è–Ω–∏–µ ===
  const STORAGE_KEY = "lunamatrix_state_v2";
  const State = {
    stage: "ASK_NAME",
    name: "",
    birthdate: "",
    service: "", // prognostics | compatibility | realization | full
    format: "",  // text | pdf

    // –¥–æ–ø. –ø–æ–ª—è
    year: "",
    partner_birthdate: "",
  };

  const elMessages = document.getElementById("messages");
  const elInput = document.getElementById("textInput");
  const elSend = document.getElementById("sendBtn");
  const elReset = document.getElementById("resetBtn");
  const elStatus = document.getElementById("statusText");

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return {...State};
      const s = JSON.parse(raw);
      return {...State, ...s};
    }catch(e){
      return {...State};
    }
  }
  function saveState(s){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
  }
  let state = loadState();

  function setStatus(){
    elStatus.textContent = state.name ? state.name : "–ì–æ—Å—Ç—å";
  }

  // === UI helpers ===
  function timeStr(){
    const d = new Date();
    return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
  }

  function addRow(who, text, meta=true){
    const row = document.createElement("div");
    row.className = "row " + (who === "user" ? "user" : "bot");
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;
    row.appendChild(bubble);

    if(meta){
      const m = document.createElement("div");
      m.className = "meta";
      m.textContent = timeStr();
      row.appendChild(m);
    }

    elMessages.appendChild(row);
    elMessages.scrollTop = elMessages.scrollHeight;
  }

  function addTyping(){
    const row = document.createElement("div");
    row.className = "row bot";
    row.dataset.typing = "1";
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    const t = document.createElement("span");
    t.className = "typing";
    t.innerHTML = "<i></i><i></i><i></i>";
    bubble.appendChild(t);
    row.appendChild(bubble);
    elMessages.appendChild(row);
    elMessages.scrollTop = elMessages.scrollHeight;
  }
  function removeTyping(){
    const t = elMessages.querySelector('[data-typing="1"]');
    if(t) t.remove();
  }

  function addActions(buttons){
    const wrap = document.createElement("div");
    wrap.className = "actions";
    buttons.forEach(b=>{
      const btn = document.createElement("div");
      btn.className = "kbtn" + (b.primary ? " primary" : "");
      btn.textContent = b.label;
      btn.addEventListener("click", b.onClick);
      wrap.appendChild(btn);
    });

    const row = document.createElement("div");
    row.className = "row bot";
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.appendChild(wrap);
    row.appendChild(bubble);
    elMessages.appendChild(row);
    elMessages.scrollTop = elMessages.scrollHeight;
  }

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  function normalizeBirthdate(x){
    const m = (x || "").trim().match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
    return m ? `${m[1]}.${m[2]}.${m[3]}` : "";
  }
  function normalizeYear(x){
    const m = (x || "").trim().match(/^(20\d{2}|19\d{2})$/);
    return m ? m[1] : "";
  }

  function serviceLabel(svc){
    if(svc === "prognostics") return "–ü—Ä–æ–≥–Ω–æ—Å—Ç–∏–∫–∞";
    if(svc === "compatibility") return "–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å";
    if(svc === "realization") return "–î–µ–Ω—å–≥–∏ / –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –ü—Ä–æ—Ñ–µ—Å—Å–∏–∏";
    if(svc === "full") return "–ü–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç (–≤—Å—ë —Å—Ä–∞–∑—É)";
    return svc || "";
  }

  // === API ===
  async function postJson(path, payload){
    const resp = await fetch(`${API_BASE}${path}`, {
      method: "POST",
      headers: { "content-type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await resp.json().catch(()=> ({}));
    return { ok: resp.ok, status: resp.status, data };
  }

  async function downloadPdf({ title, filename, text }){
    const resp = await fetch(`${API_BASE}/pdf`, {
      method: "POST",
      headers: { "content-type":"application/json" },
      body: JSON.stringify({ title, filename, text })
    });
    if(!resp.ok){
      const t = await resp.text().catch(()=> "");
      throw new Error(`PDF error ${resp.status}: ${t.slice(0,200)}`);
    }
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename || "lunamatrix.pdf";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // === flow ===
  function startIfEmpty(){
    if(elMessages.children.length > 0) return;

    if(state.name && state.birthdate){
      addRow("bot", `–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${state.name}! üíñ –ü—Ä–æ–¥–æ–ª–∂–∏–º?`);
      showServiceButtons();
      state.stage = "CHOOSE_SERVICE";
      saveState(state);
      setStatus();
      return;
    }

    addRow("bot",
`–ü—Ä–∏–≤–µ—Ç ‚ú®üåô‚ú® –Ø —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ LunaMatrix üíñ
–ö–∞–∫ —è –º–æ–≥—É –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è?`);
    state.stage = "ASK_NAME";
    saveState(state);
    setStatus();
  }

  async function runDemo(){
    addTyping();
    await sleep(450);

    const r = await postJson("/demo", { name: state.name, birthdate: state.birthdate });
    removeTyping();

    if(!r.ok){
      addRow("bot", `–ù–µ —Å–º–æ–≥–ª–∞ –ø–æ–ª—É—á–∏—Ç—å –¥–µ–º–æ üòî\n–û—à–∏–±–∫–∞: ${r.data?.error || "unknown"}`);
      return;
    }

    addRow("bot", r.data?.text || "–î–µ–º–æ –≥–æ—Ç–æ–≤–æ ‚ú®");
    addRow("bot", "–ò–¥–µ–º –¥–∞–ª—å—à–µüíñ –í—ã–±–∏—Ä–∞–π –Ω–∏–∂–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é");
    state.stage = "CHOOSE_SERVICE";
    saveState(state);
    showServiceButtons();
  }

  function showServiceButtons(){
    addActions([
      { label:"üîÆ –ü—Ä–æ–≥–Ω–æ—Å—Ç–∏–∫–∞", primary:true, onClick:()=>selectService("prognostics") },
      { label:"üíû –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å", onClick:()=>selectService("compatibility") },
      { label:"ü§ë –î–µ–Ω—å–≥–∏ / –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –ü—Ä–æ—Ñ–µ—Å—Å–∏–∏", onClick:()=>selectService("realization") },
      { label:"üî• –ü–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç (–≤—Å—ë —Å—Ä–∞–∑—É)", onClick:()=>selectService("full") },
    ]);
  }

  function showFormatButtons(){
    addActions([
      { label:"üí¨ –¢–µ–∫—Å—Ç –≤ —á–∞—Ç–µ", onClick:()=>chooseFormat("text") },
      { label:"üìÑ PDF (—Å–∫–∞—á–∞—Ç—å)", primary:true, onClick:()=>chooseFormat("pdf") },
    ]);
  }

  function selectService(svc){
    state.service = svc;
    state.format = "";
    state.year = "";
    state.partner_birthdate = "";
    saveState(state);

    addRow("bot", `–í—ã–±—Ä–∞–Ω–æ: ${serviceLabel(svc)}.\n–ö–∞–∫ —É–¥–æ–±–Ω–µ–µ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç?`, false);
    showFormatButtons();
    state.stage = "CHOOSE_FORMAT";
    saveState(state);
  }

  function chooseFormat(fmt){
    state.format = fmt; // text | pdf
    saveState(state);

    // –°–Ω–∞—á–∞–ª–∞ —Å–æ–±–∏—Ä–∞–µ–º –¥–æ–ø. –¥–∞–Ω–Ω—ã–µ –ø–æ —É—Å–ª—É–≥–µ
    if(state.service === "prognostics"){
      addRow("bot", "–î–ª—è –ø—Ä–æ–≥–Ω–æ—Å—Ç–∏–∫–∏ —É–∫–∞–∂–∏ –≥–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä 2026)");
      state.stage = "ASK_YEAR";
      saveState(state);
      return;
    }
    if(state.service === "compatibility"){
      addRow("bot", "–î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –Ω—É–∂–Ω–∞ –¥–∞—Ç–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ ‚Äî —Å—Ç—Ä–æ–≥–æ –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä 30.05.1990)");
      state.stage = "ASK_PARTNER_BIRTHDATE";
      saveState(state);
      return;
    }

    // realization/full ‚Äî –¥–æ–ø. –ø–æ–ª–µ–π –Ω–µ –ø—Ä–æ—Å–∏–º (–ø–æ–∫–∞)
    runServiceNow();
  }

  async function runServiceNow(){
    addTyping();
    await sleep(350);

    const payload = {
      service: state.service,
      name: state.name,
      birthdate: state.birthdate,
    };
    if(state.service === "prognostics") payload.year = state.year;
    if(state.service === "compatibility") payload.partner_birthdate = state.partner_birthdate;

    const r = await postJson("/service", payload);
    removeTyping();

    if(!r.ok){
      addRow("bot", `–û—à–∏–±–∫–∞ /service üòî\n${r.data?.error || "unknown"}`);
      state.stage = "CHOOSE_SERVICE";
      saveState(state);
      showServiceButtons();
      return;
    }

    const text = r.data?.text || "";
    if(!text){
      addRow("bot", "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
      return;
    }

    if(state.format === "text"){
      addRow("bot", text);
      state.stage = "CHOOSE_SERVICE";
      saveState(state);
      showServiceButtons();
      return;
    }

    // pdf
    try{
      const title =
        state.service === "prognostics"
          ? `–ü—Ä–æ–≥–Ω–æ—Å—Ç–∏–∫–∞ ${state.year} ‚Äî ${state.name}`
          : state.service === "compatibility"
            ? `–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å ‚Äî ${state.name}`
            : state.service === "realization"
              ? `–†–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî ${state.name}`
              : `–ü–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç ‚Äî ${state.name}`;

      const filename =
        state.service === "prognostics"
          ? `lunamatrix-prognostics-${state.year}.pdf`
          : `lunamatrix-${state.service}.pdf`;

      addRow("bot", "–ì–æ—Ç–æ–≤–ª—é PDF‚Ä¶");
      await downloadPdf({ title, filename, text });
      addRow("bot", "PDF —Å–∫–∞—á–∞–Ω ‚úÖ");

      state.stage = "CHOOSE_SERVICE";
      saveState(state);
      showServiceButtons();
    }catch(e){
      addRow("bot", `–ù–µ —Å–º–æ–≥–ª–∞ —Å–æ–±—Ä–∞—Ç—å PDF üòî\n${String(e).slice(0,180)}`);
      state.stage = "CHOOSE_SERVICE";
      saveState(state);
      showServiceButtons();
    }
  }

  async function handleUserText(text){
    const msg = (text || "").trim();
    if(!msg) return;

    addRow("user", msg);

    if(state.stage === "ASK_NAME"){
      state.name = msg.split(/\s+/)[0].slice(0, 24);
      saveState(state);
      setStatus();

      addTyping();
      await sleep(250);
      removeTyping();

      addRow("bot", `–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, ${state.name}! üí´\n–ù–∞–ø–∏—à–∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä, 20.08.1989)`);
      state.stage = "ASK_BIRTHDATE";
      saveState(state);
      return;
    }

    if(state.stage === "ASK_BIRTHDATE"){
      const bd = normalizeBirthdate(msg);
      if(!bd){
        addRow("bot", "–î–∞—Ç–∞ —Å—Ç—Ä–æ–≥–æ –î–î.–ú–ú.–ì–ì–ì–ì, –Ω–∞–ø—Ä–∏–º–µ—Ä 20.08.1989");
        return;
      }
      state.birthdate = bd;
      saveState(state);
      await runDemo();
      return;
    }

    if(state.stage === "ASK_YEAR"){
      const y = normalizeYear(msg);
      if(!y){
        addRow("bot", "–ì–æ–¥ ‚Äî 4 —Ü–∏—Ñ—Ä—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä 2026");
        return;
      }
      state.year = y;
      saveState(state);
      await runServiceNow();
      return;
    }

    if(state.stage === "ASK_PARTNER_BIRTHDATE"){
      const pbd = normalizeBirthdate(msg);
      if(!pbd){
        addRow("bot", "–î–∞—Ç–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ —Å—Ç—Ä–æ–≥–æ –î–î.–ú–ú.–ì–ì–ì–ì, –Ω–∞–ø—Ä–∏–º–µ—Ä 30.05.1990");
        return;
      }
      state.partner_birthdate = pbd;
      saveState(state);
      await runServiceNow();
      return;
    }

    addRow("bot", "–î–∞–≤–∞–π –ø–æ –∫–Ω–æ–ø–∫–∞–º üôÇ –í—ã–±–µ—Ä–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –Ω–∏–∂–µ.");
    showServiceButtons();
    state.stage = "CHOOSE_SERVICE";
    saveState(state);
  }

  // === events ===
  elSend.addEventListener("click", ()=>{
    const v = elInput.value;
    elInput.value = "";
    handleUserText(v);
  });
  elInput.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      elSend.click();
    }
  });
  elReset.addEventListener("click", ()=>{
    localStorage.removeItem(STORAGE_KEY);
    state = {...State};
    elMessages.innerHTML = "";
    setStatus();
    startIfEmpty();
  });

  // start
  setStatus();
  startIfEmpty();
</script>
</body>
</html>
