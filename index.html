<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LunaMatrix ‚Äî –ù—É–º–µ—Ä–æ–ª–æ–≥-—ç–∫—Å–ø–µ—Ä—Ç</title>
  <meta name="description" content="–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–µ–º–æ-–æ—Ç–≤–µ—Ç—ã –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏. PDF ‚Äî –ø–æ—Å–ª–µ e-mail." />
  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1020;
      --card:#0E1630cc;
      --stroke:#223055;
      --text:#EAF0FF;
      --muted:#AAB6DA;
      --accent:#6B8CFF;
      --accent2:#B06BFF;
      --good:#31D0AA;
      --warn:#FFB020;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 24px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 70% -10%, rgba(107,140,255,.25), transparent 60%),
        radial-gradient(900px 700px at 10% 10%, rgba(176,107,255,.20), transparent 55%),
        radial-gradient(700px 600px at 70% 110%, rgba(49,208,170,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 14px;
    }
    .app{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:18px;
    }
    @media (max-width: 920px){
      .app{grid-template-columns:1fr}
    }
    .hero{
      border:1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      border-radius: var(--radius2);
      padding:22px 22px 18px;
      position:relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(400px 260px at 20% 20%, rgba(107,140,255,.25), transparent 60%),
        radial-gradient(420px 300px at 90% 0%, rgba(176,107,255,.22), transparent 60%);
      filter: blur(10px);
      opacity:.9;
      pointer-events:none;
    }
    .hero > *{position:relative}
    .brand{
      display:flex; align-items:center; gap:12px;
      margin-bottom:10px;
    }
    .logo{
      width:46px; height:46px;
      border-radius:14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(107,140,255,.95), rgba(176,107,255,.9));
      box-shadow: 0 12px 30px rgba(107,140,255,.25);
      border:1px solid rgba(255,255,255,.14);
    }
    .logo span{font-size:22px; transform: translateY(-1px)}
    .title{line-height:1.1;}
    .title h1{margin:0; font-size:20px; letter-spacing:.2px}
    .title p{margin:4px 0 0; color:var(--muted); font-size:13px}
    .chips{
      display:flex; flex-wrap:wrap; gap:8px;
      margin:14px 0 0;
    }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(14,22,48,.55);
      color:var(--muted);
      font-size:12px;
    }

    .chat{
      border:1px solid rgba(255,255,255,.07);
      background: rgba(14,22,48,.45);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 560px;
    }
    .chat-head{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .status{
      display:flex; align-items:center; gap:8px;
      color:var(--muted);
      font-size:12px;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--good);
      box-shadow: 0 0 0 6px rgba(49,208,170,.12);
    }
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.15);
      color:var(--muted);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .pill:hover{border-color:rgba(107,140,255,.35); color:var(--text)}
    .messages{
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
      flex:1;
    }
    .row{
      display:flex;
      align-items:flex-end;
      gap:8px;
      max-width: 92%;
    }
    .row.user{margin-left:auto; flex-direction:row-reverse}
    .bubble{
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.15);
      white-space:pre-wrap;
      line-height:1.35;
      font-size:14px;
    }
    .row.bot .bubble{
      background: rgba(14,22,48,.70);
      border-color: rgba(255,255,255,.10);
    }
    .row.user .bubble{
      background: linear-gradient(135deg, rgba(107,140,255,.30), rgba(176,107,255,.22));
      border-color: rgba(107,140,255,.35);
    }
    .meta{
      font-size:11px; color:rgba(170,182,218,.75);
      margin:0 4px;
    }
    .typing{
      display:inline-flex; align-items:center; gap:6px;
    }
    .typing i{
      width:6px;height:6px;border-radius:50%;
      background: rgba(234,240,255,.65);
      display:inline-block;
      animation: bounce 1.1s infinite ease-in-out;
    }
    .typing i:nth-child(2){animation-delay:.15s}
    .typing i:nth-child(3){animation-delay:.30s}
    @keyframes bounce{
      0%,80%,100%{transform:translateY(0); opacity:.55}
      40%{transform:translateY(-4px); opacity:1}
    }

    .composer{
      padding:12px 12px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      align-items:center;
      background: rgba(0,0,0,.10);
    }
    .input{
      flex:1;
      display:flex;
      gap:10px;
      align-items:center;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(14,22,48,.55);
      border-radius: 14px;
      padding:10px 12px;
    }
    input{
      width:100%;
      background:transparent;
      border:0;
      outline:none;
      color:var(--text);
      font-size:14px;
    }
    input::placeholder{color:rgba(170,182,218,.65)}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(107,140,255,.18);
      color:var(--text);
      padding:10px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }
    .btn:hover{border-color:rgba(107,140,255,.55); background: rgba(107,140,255,.26)}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }
    .kbtn{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(14,22,48,.55);
      cursor:pointer;
      color:var(--text);
      font-size:13px;
      user-select:none;
    }
    .kbtn:hover{border-color:rgba(107,140,255,.45)}
    .kbtn.primary{
      background: rgba(107,140,255,.20);
      border-color: rgba(107,140,255,.35);
    }
    .small{
      font-size:12px;
      color:rgba(170,182,218,.78);
      margin-top:10px;
      line-height:1.35;
    }
    .right{
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .card{
      border:1px solid rgba(255,255,255,.07);
      background: rgba(14,22,48,.35);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .card h3{margin:0 0 8px; font-size:16px}
    .card p{margin:0; color:var(--muted); font-size:13px; line-height:1.45}
    .warn{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,176,32,.25);
      background: rgba(255,176,32,.08);
      color:rgba(255,224,170,.95);
      font-size:12px;
      line-height:1.35;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="app">
    <div class="hero">
      <div class="brand">
        <div class="logo"><span>üåô</span></div>
        <div class="title">
          <h1>–ù—É–º–µ—Ä–æ–ª–æ–≥-—ç–∫—Å–ø–µ—Ä—Ç LunaMatrix</h1>
          <p>–î–µ–º–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ. PDF –∏ –ø–æ–∫—É–ø–∫–∏ ‚Äî –ø–æ—Å–ª–µ e-mail.</p>
        </div>
      </div>

      <div class="chips">
        <div class="chip">‚ú® –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –¥–µ–º–æ-–æ—Ç–≤–µ—Ç</div>
        <div class="chip">üíû –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</div>
        <div class="chip">ü§ë –î–µ–Ω—å–≥–∏ / –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –ü—Ä–æ—Ñ–µ—Å—Å–∏–∏</div>
        <div class="chip">üîÆ –ü—Ä–æ–≥–Ω–æ—Å—Ç–∏–∫–∞ 2026</div>
        <div class="chip">üî• –ü–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç</div>
      </div>

      <div class="small">
        –°—Ü–µ–Ω–∞—Ä–∏–π: –∏–º—è ‚Üí –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è ‚Üí –¥–µ–º–æ ‚Üí –≤—ã–±–æ—Ä —É—Å–ª—É–≥–∏ ‚Üí (–µ—Å–ª–∏ –Ω–∞–¥–æ: —É—Ç–æ—á–Ω—è—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ) ‚Üí —Ç–µ–∫—Å—Ç/PDF.
      </div>
    </div>

    <div class="right">
      <div class="chat" id="chat">
        <div class="chat-head">
          <div class="status">
            <span class="dot"></span>
            <span id="statusText">–ì–æ—Å—Ç—å</span>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <div class="pill" id="resetBtn">–°–±—Ä–æ—Å</div>
          </div>
        </div>

        <div class="messages" id="messages"></div>

        <div class="composer">
          <div class="input">
            <input id="textInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" autocomplete="off"/>
          </div>
          <button class="btn" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div class="card">
        <h3>–í–∞–∂–Ω–æ</h3>
        <p>–î–µ–º–æ ‚Äî —á–µ—Ä–µ–∑ Cloudflare Worker (<code>/demo</code>). –ü–æ–ª–Ω—ã–µ —É—Å–ª—É–≥–∏ ‚Äî —á–µ—Ä–µ–∑ <code>/service</code>. PDF –ø–æ–¥–∫–ª—é—á–∏–º –æ—Ç–¥–µ–ª—å–Ω—ã–º —à–∞–≥–æ–º.</p>
        <div class="warn">
          –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—å <code>/demo</code> –∏–ª–∏ <code>/service</code> –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Äî —ç—Ç–æ GET –∏ –±—É–¥–µ—Ç ‚ÄúNot found‚Äù. –†–∞–±–æ—Ç–∞–µ—Ç POST-–∑–∞–ø—Ä–æ—Å–æ–º –∏–∑ —Å–∞–π—Ç–∞.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // === –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ===
  const API_BASE = "https://numerology-api.kseniabarzali.workers.dev"; // —Ç–≤–æ–π Worker

  // === –°–æ—Å—Ç–æ—è–Ω–∏–µ ===
  const STORAGE_KEY = "lunamatrix_state_v2";
  const DefaultState = {
    stage: "ASK_NAME",
    name: "",
    birthdate: "",

    // –≤—ã–±—Ä–∞–Ω–Ω–∞—è —É—Å–ª—É–≥–∞ (–∫–ª—é—á–∏ –¥–ª—è /service)
    serviceKey: "", // "prognostics" | "compatibility" | "realization" | "full"

    // –¥–æ–ø. –¥–∞–Ω–Ω—ã–µ
    partner_birthdate: "",
    year: "",

    // —Ñ–æ—Ä–º–∞—Ç
    format: "", // "text" | "pdf"
  };

  const elMessages = document.getElementById("messages");
  const elInput = document.getElementById("textInput");
  const elSend = document.getElementById("sendBtn");
  const elReset = document.getElementById("resetBtn");
  const elStatus = document.getElementById("statusText");

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return {...DefaultState};
      const s = JSON.parse(raw);
      return {...DefaultState, ...s};
    }catch(e){
      return {...DefaultState};
    }
  }
  function saveState(s){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
  }
  let state = loadState();

  function setStatus(){
    elStatus.textContent = state.name ? state.name : "–ì–æ—Å—Ç—å";
  }

  // === UI helpers ===
  function timeStr(){
    const d = new Date();
    return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
  }

  function addRow(who, text, meta=true){
    const row = document.createElement("div");
    row.className = "row " + (who === "user" ? "user" : "bot");
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;
    row.appendChild(bubble);

    if(meta){
      const m = document.createElement("div");
      m.className = "meta";
      m.textContent = timeStr();
      row.appendChild(m);
    }

    elMessages.appendChild(row);
    elMessages.scrollTop = elMessages.scrollHeight;
  }

  function addTyping(){
    const row = document.createElement("div");
    row.className = "row bot";
    row.dataset.typing = "1";
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    const t = document.createElement("span");
    t.className = "typing";
    t.innerHTML = "<i></i><i></i><i></i>";
    bubble.appendChild(t);
    row.appendChild(bubble);
    elMessages.appendChild(row);
    elMessages.scrollTop = elMessages.scrollHeight;
  }
  function removeTyping(){
    const t = elMessages.querySelector('[data-typing="1"]');
    if(t) t.remove();
  }

  function addActions(buttons){
    const wrap = document.createElement("div");
    wrap.className = "actions";
    buttons.forEach(b=>{
      const btn = document.createElement("div");
      btn.className = "kbtn" + (b.primary ? " primary" : "");
      btn.textContent = b.label;
      btn.addEventListener("click", b.onClick);
      wrap.appendChild(btn);
    });

    const row = document.createElement("div");
    row.className = "row bot";
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.appendChild(wrap);
    row.appendChild(bubble);
    elMessages.appendChild(row);
    elMessages.scrollTop = elMessages.scrollHeight;
  }

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  function normalizeBirthdate(x){
    const m = (x || "").trim().match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
    return m ? `${m[1]}.${m[2]}.${m[3]}` : "";
  }

  function normalizeYear(x){
    const y = (x || "").trim().match(/^\d{4}$/);
    return y ? y[0] : "";
  }

  // === API calls ===
  async function apiPost(path, payload){
    const resp = await fetch(`${API_BASE}${path}`, {
      method: "POST",
      headers: { "content-type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await resp.json().catch(()=> ({}));
    if(!resp.ok){
      const err = data?.error || `HTTP ${resp.status}`;
      throw new Error(err);
    }
    return data;
  }

  // === –°—Ü–µ–Ω–∞—Ä–∏–π ===
  function startIfEmpty(){
    if(elMessages.children.length > 0) return;

    if(state.name && state.birthdate){
      addRow("bot", `–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${state.name}! üíñ`);
      addRow("bot", "–í—ã–±–∏—Ä–∞–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –Ω–∏–∂–µ:");
      state.stage = "CHOOSE_SERVICE";
      saveState(state);
      setStatus();
      showServiceButtons();
      return;
    }

    addRow("bot",
`–ü—Ä–∏–≤–µ—Ç ‚ú®üåô‚ú® –Ø —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ LunaMatrix üíñ
–ö–∞–∫ —è –º–æ–≥—É –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è?`);
    state.stage = "ASK_NAME";
    saveState(state);
    setStatus();
  }

  async function handleUserText(text){
    const msg = (text || "").trim();
    if(!msg) return;

    addRow("user", msg);

    // 1) –∏–º—è
    if(state.stage === "ASK_NAME"){
      state.name = msg.split(/\s+/)[0].slice(0, 24);
      saveState(state);
      setStatus();

      addTyping(); await sleep(350); removeTyping();

      addRow("bot",
`–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, ${state.name}! üí´
–ù–∞–ø–∏—à–∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì (–ø—Ä–∏–º–µ—Ä: 20.08.1989)`);
      state.stage = "ASK_BIRTHDATE";
      saveState(state);
      return;
    }

    // 2) –¥–∞—Ç–∞
    if(state.stage === "ASK_BIRTHDATE"){
      const bd = normalizeBirthdate(msg);
      if(!bd){
        addRow("bot", "–ù–∞–ø–∏—à–∏ –¥–∞—Ç—É —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì, –Ω–∞–ø—Ä–∏–º–µ—Ä 20.08.1989");
        return;
      }
      state.birthdate = bd;
      saveState(state);
      await runDemo();
      return;
    }

    // 3) –¥–æ–ø. –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É—Å–ª—É–≥–∏
    if(state.stage === "ASK_PARTNER_BIRTHDATE"){
      const pbd = normalizeBirthdate(msg);
      if(!pbd){
        addRow("bot", "–î–∞—Ç—É –ø–∞—Ä—Ç–Ω—ë—Ä–∞ ‚Äî —Å—Ç—Ä–æ–≥–æ –î–î.–ú–ú.–ì–ì–ì–ì, –Ω–∞–ø—Ä–∏–º–µ—Ä 30.05.1990");
        return;
      }
      state.partner_birthdate = pbd;
      saveState(state);
      await runServiceText();
      return;
    }

    if(state.stage === "ASK_YEAR"){
      const y = normalizeYear(msg);
      if(!y){
        addRow("bot", "–ì–æ–¥ ‚Äî 4 —Ü–∏—Ñ—Ä—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä 2026");
        return;
      }
      state.year = y;
      saveState(state);
      await runServiceText();
      return;
    }

    if(state.stage === "ASK_EMAIL"){
      const email = msg.toLowerCase();
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
        addRow("bot", "E-mail —Å –æ—à–∏–±–∫–æ–π. –ü—Ä–∏–º–µ—Ä: name@gmail.com");
        return;
      }
      addRow("bot", `–û–∫ üíå e-mail: ${email}\nPDF –ø–æ–¥–∫–ª—é—á–∏–º —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º (/pdf). –ü–æ–∫–∞ –º–æ–≥—É –≤—ã–¥–∞—Ç—å —Ç–µ–∫—Å—Ç.`);
      state.stage = "CHOOSE_SERVICE";
      state.format = "";
      saveState(state);
      showServiceButtons();
      return;
    }

    // fallback
    addRow("bot", "–î–∞–≤–∞–π –ø–æ —à–∞–≥–∞–º üôÇ –í—ã–±–∏—Ä–∞–π —É—Å–ª—É–≥—É –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∏–∂–µ.");
    showServiceButtons();
  }

  async function runDemo(){
    addTyping(); await sleep(450);
    try{
      const data = await apiPost("/demo", { name: state.name, birthdate: state.birthdate });
      removeTyping();

      addRow("bot", data?.text || "–î–µ–º–æ –≥–æ—Ç–æ–≤–æ ‚ú®");
      addRow("bot", "–ò–¥–µ–º –¥–∞–ª—å—à–µüíñ –í—ã–±–∏—Ä–∞–π –Ω–∏–∂–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é");
      state.stage = "CHOOSE_SERVICE";
      saveState(state);
      showServiceButtons();
    }catch(e){
      removeTyping();
      addRow("bot", `–ù–µ —Å–º–æ–≥–ª–∞ –ø–æ–ª—É—á–∏—Ç—å –¥–µ–º–æ üòî\n–û—à–∏–±–∫–∞: ${e.message}`);
    }
  }

  // === –ö–Ω–æ–ø–∫–∏ —É—Å–ª—É–≥ ===
  function showServiceButtons(){
    addActions([
      { label:"üîÆ –ü—Ä–æ–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–∞ 2026 –≥–æ–¥", primary:true, onClick:()=>selectService("prognostics") },
      { label:"üíû –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å", onClick:()=>selectService("compatibility") },
      { label:"ü§ë –î–µ–Ω—å–≥–∏ / –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –ü—Ä–æ—Ñ–µ—Å—Å–∏–∏", onClick:()=>selectService("realization") },
      { label:"üî• –ü–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç (–≤—Å—ë —Å—Ä–∞–∑—É)", onClick:()=>selectService("full") },
    ]);
  }

  function serviceLabel(key){
    if(key === "prognostics") return "–ü—Ä–æ–≥–Ω–æ—Å—Ç–∏–∫–∞";
    if(key === "compatibility") return "–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å";
    if(key === "realization") return "–î–µ–Ω—å–≥–∏ / –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –ü—Ä–æ—Ñ–µ—Å—Å–∏–∏";
    if(key === "full") return "–ü–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç (–≤—Å—ë —Å—Ä–∞–∑—É)";
    return key || "";
  }

  function selectService(serviceKey){
    state.serviceKey = serviceKey;
    state.format = "";
    saveState(state);

    addRow("bot", `–í—ã–±—Ä–∞–Ω–æ: ${serviceLabel(serviceKey)}.\n–ö–∞–∫ —É–¥–æ–±–Ω–µ–µ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç?`, false);
    addActions([
      { label:"üí¨ –¢–µ–∫—Å—Ç –≤ —á–∞—Ç–µ", primary:true, onClick:()=>chooseFormat("text") },
      { label:"üìÑ PDF (–Ω—É–∂–µ–Ω e-mail)", onClick:()=>chooseFormat("pdf") },
    ]);
  }

  async function chooseFormat(fmt){
    state.format = fmt;
    saveState(state);

    if(fmt === "pdf"){
      addRow("bot", "–û–∫ üìÑ –ù–∞–ø–∏—à–∏ e-mail (PDF –ø–æ–¥–∫–ª—é—á–∏–º —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º).");
      state.stage = "ASK_EMAIL";
      saveState(state);
      return;
    }

    // fmt === "text" ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω—ã –ª–∏ –¥–æ–ø. –¥–∞–Ω–Ω—ã–µ
    if(state.serviceKey === "compatibility" && !state.partner_birthdate){
      addRow("bot", "–î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –Ω—É–∂–Ω–∞ –¥–∞—Ç–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–∞: –î–î.–ú–ú.–ì–ì–ì–ì (–ø—Ä–∏–º–µ—Ä 30.05.1990)");
      state.stage = "ASK_PARTNER_BIRTHDATE";
      saveState(state);
      return;
    }
    if(state.serviceKey === "prognostics" && !state.year){
      addRow("bot", "–î–ª—è –ø—Ä–æ–≥–Ω–æ—Å—Ç–∏–∫–∏ —É–∫–∞–∂–∏ –≥–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä 2026)");
      state.stage = "ASK_YEAR";
      saveState(state);
      return;
    }

    await runServiceText();
  }

  async function runServiceText(){
    const payload = {
      service: state.serviceKey,
      name: state.name,
      birthdate: state.birthdate,
      format: "text",
    };
    if(state.partner_birthdate) payload.partner_birthdate = state.partner_birthdate;
    if(state.year) payload.year = state.year;

    addTyping(); await sleep(450);

    try{
      const data = await apiPost("/service", payload);
      removeTyping();

      // –≤—ã–≤–æ–¥
      addRow("bot", data?.text || "–ì–æ—Ç–æ–≤–æ ‚ú®");

      // –¥–∞–ª—å—à–µ: —Å–Ω–æ–≤–∞ –º–µ–Ω—é
      state.stage = "CHOOSE_SERVICE";
      saveState(state);
      showServiceButtons();

    }catch(e){
      removeTyping();
      addRow("bot", `–ù–µ —Å–º–æ–≥–ª–∞ –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é üòî\n–û—à–∏–±–∫–∞: ${e.message}`);
      state.stage = "CHOOSE_SERVICE";
      saveState(state);
      showServiceButtons();
    }
  }

  // === Events ===
  elSend.addEventListener("click", ()=>{
    const v = elInput.value;
    elInput.value = "";
    handleUserText(v);
  });
  elInput.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      elSend.click();
    }
  });
  elReset.addEventListener("click", ()=>{
    localStorage.removeItem(STORAGE_KEY);
    state = {...DefaultState};
    elMessages.innerHTML = "";
    setStatus();
    startIfEmpty();
  });

  // —Å—Ç–∞—Ä—Ç
  setStatus();
  startIfEmpty();
</script>
</body>
</html>
