<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Нумерология — демо</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:#0b0f17; color:#fff; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 18px 14px 70px; }
    .top { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
    .badge { font-size:12px; opacity:.85; padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:999px; background: rgba(255,255,255,.04); }
    .card { background:#121a2a; border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px; }
    .msgs { display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .m { padding:10px 12px; border-radius:14px; max-width: 92%; white-space:pre-wrap; line-height:1.35; }
    .u { align-self:flex-end; background:#2a3b63; border:1px solid rgba(255,255,255,.12); }
    .a { align-self:flex-start; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); }
    .bar { position: fixed; left:0; right:0; bottom:0; background: rgba(11,15,23,.9); backdrop-filter: blur(10px); border-top:1px solid rgba(255,255,255,.08); }
    .bar .inner { max-width: 720px; margin: 0 auto; padding: 10px 14px; display:flex; gap:10px; }
    input { flex:1; padding:12px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.15); background:#0b1220; color:#fff; }
    button { padding:12px 14px; border-radius:12px; border:0; background:#4f7cff; color:#fff; font-weight:600; cursor:pointer; }
    button.secondary { background:#27324b; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .hint { font-size:12px; opacity:.75; margin-top:8px; }
    /* modal */
    .overlay { position:fixed; inset:0; background: rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:16px; }
    .modal { width:min(520px, 100%); background:#121a2a; border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:14px; }
    .modal h3 { margin:0 0 8px; font-size:16px; }
    .msg { margin-top:10px; padding:10px 12px; border-radius:12px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); }
    a { color:#9bb6ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div style="font-size:18px; font-weight:700;">Нумеролог-эксперт</div>
        <div class="hint">Демо бесплатно. PDF и покупки — после ввода e-mail.</div>
      </div>
      <div id="authBadge" class="badge">Гость</div>
    </div>

    <div class="card">
      <div class="actions">
        <button id="demoBtn" class="secondary">Получить демо-ответ</button>
        <button id="pdfBtn">Сформировать PDF (нужен e-mail)</button>
        <button id="loginBtn" class="secondary" style="display:none;">Войти по e-mail</button>
        <button id="logoutBtn" class="secondary" style="display:none;">Выйти</button>
      </div>

      <div id="msgs" class="msgs"></div>
      <div class="hint">Подсказка: напиши дату рождения, например <b>20.08.1989</b> и что хочешь узнать.</div>
    </div>
  </div>

  <!-- bottom input -->
  <div class="bar">
    <div class="inner">
      <input id="text" placeholder="Напишите сообщение…" />
      <button id="send">Отправить</button>
    </div>
  </div>

  <!-- modal email -->
  <div id="overlay" class="overlay">
    <div class="modal">
      <h3>Введите e-mail для PDF</h3>
      <div class="hint">Мы пришлём ссылку для входа (без пароля). После подтверждения откроются ваши отчёты и PDF.</div>
      <div style="margin-top:10px;">
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email"/>
        <div class="actions" style="margin-top:10px;">
          <button id="sendLink">Отправить ссылку</button>
          <button id="close" class="secondary">Отмена</button>
        </div>
        <div id="modalMsg" class="msg" style="display:none;"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://wceramzbrsvlyemngqye.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndjZXJhbXpicnN2bHllbW5ncXllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MDgxNzUsImV4cCI6MjA4NjQ4NDE3NX0.vIpHdkuyLEJYtg-FYjd-zfDarXkjgFILpKJyi9Sc2zs";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const el = (id) => document.getElementById(id);
    const msgs = el("msgs");

    const addMsg = (role, text) => {
      const d = document.createElement("div");
      d.className = "m " + (role === "user" ? "u" : "a");
      d.textContent = text;
      msgs.appendChild(d);
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    };

    // Простая демо-логика (пока без OpenAI). Следующим шагом подключим Worker.
    const demoAnswer = (question) => {
      return [
        "ДЕМО-ОТВЕТ (пример):",
        "• Вижу запрос: " + (question || "общий разбор"),
        "• Могу сделать: личность, деньги/реализация, совместимость, прогнозы.",
        "• Для полного разбора нужен PDF — там будет структура, рекомендации и ключевые периоды.",
        "",
        "Напишите дату рождения и тему (например: «20.08.1989 — деньги и профессии»)."
      ].join("\n");
    };

    const setAuthUI = async () => {
      const { data } = await supabase.auth.getSession();
      const s = data.session;
      el("authBadge").textContent = s ? ("Вход: " + (s.user.email || "ok")) : "Гость";
      el("loginBtn").style.display = s ? "none" : "inline-block";
      el("logoutBtn").style.display = s ? "inline-block" : "none";
    };

    await setAuthUI();
    supabase.auth.onAuthStateChange(() => setAuthUI());

    // Buttons
    el("demoBtn").onclick = () => addMsg("assistant", demoAnswer());

    // PDF button: если не залогинен — просим email
    el("pdfBtn").onclick = async () => {
      const { data } = await supabase.auth.getSession();
      if (!data.session) {
        el("overlay").style.display = "flex";
        el("modalMsg").style.display = "none";
        return;
      }
      addMsg("assistant", "Ок, вы авторизованы. Дальше подключим генерацию PDF через сервер.");
    };

    el("close").onclick = () => el("overlay").style.display = "none";

    // Отправка magic link
    el("sendLink").onclick = async () => {
      const email = el("email").value.trim();
      if (!email) return showModal("Введите e-mail", true);

      el("sendLink").disabled = true;
      try {
        // ВАЖНО: redirectTo должен быть твоим Pages доменом (чтобы после клика в письме вернуло на сайт)
        const redirectTo = window.location.origin;
        const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: redirectTo }});
        if (error) throw error;
        showModal("Ссылка отправлена. Откройте письмо и нажмите Confirm/Sign in.", false);
      } catch (e) {
        showModal("Ошибка отправки: " + (e?.message || e), true);
      } finally {
        el("sendLink").disabled = false;
      }
    };

    function showModal(text, isErr) {
      const m = el("modalMsg");
      m.style.display = "block";
      m.style.borderColor = isErr ? "rgba(255,99,99,.5)" : "rgba(79,124,255,.5)";
      m.textContent = text;
    }

    el("loginBtn").onclick = () => { el("overlay").style.display = "flex"; };

    el("logoutBtn").onclick = async () => {
      await supabase.auth.signOut();
      addMsg("assistant", "Вы вышли. Демо остаётся доступно без входа.");
    };

    // chat input (пока локально)
    el("send").onclick = () => {
      const t = el("text").value.trim();
      if (!t) return;
      addMsg("user", t);
      el("text").value = "";
      addMsg("assistant", demoAnswer(t));
    };

    el("text").addEventListener("keydown", (e) => {
      if (e.key === "Enter") el("send").click();
    });

    addMsg("assistant", "Привет! Я нумеролог-эксперт. Напишите дату рождения и тему — дам демо-ответ. PDF будет доступен после e-mail.");
  </script>
</body>
</html>
